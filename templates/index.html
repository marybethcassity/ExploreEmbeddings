<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home</title>
    <script src="{{ url_for('static', filename='js/jquery-1.11.1.min.js') }}"></script>
    <script src="https://cdn.plot.ly/plotly-2.8.3.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css"/>
    <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
    <style>
        .container {
            display: flex;
            justify-content: space-around; /* Adjust the layout as needed */
            align-items: center;
        }

        #graph {
            flex: 1; /* Allows each child to grow equally */
            width: 3840/2px; /* Adjust the width as needed */   
            height: 2160/2px;
        }
        
        #frame-container {
            flex: 1; /* Allows each child to grow equally */
            max-width: 50%; /* Adjust the width as needed */
            float: right;
            position: relative;
            overflow: hidden;  
            align-items: center;      
            justify-content: center; 
        }

        .swiper-container {
        width: 100%; /* Full width of the frame-container */
        height: 100%; /* Full height of the frame-container */
        }

        .swiper-wrapper {
            width: 100%;
            height: 100%;
        }

        .swiper-slide {
            overflow: hidden;
        }

        .swiper-slide img {
            max-width: 100%; /* Ensures the image fits within the slide */
            max-height: auto; /* Limits the image height to the slide */
            flex: none;
            object-fit: contain;
        }

        .frame-number {
            position: absolute; /* Position the frame number absolutely within the slide */
            top: 10px; /* Adjust the vertical position as needed */
            left: 10px; /* Adjust the horizontal position as needed */
            background-color: rgba(255, 255, 255, 0.8); /* Semi-transparent white background */
            padding: 5px; /* Add some padding around the text */
            font-weight: bold; /* Make the text bold for better visibility */
            z-index: 1; /* Add this line to ensure the frame number is on top of the image */
        }
        
        .frame-assignment {
            position: absolute; /* Position the frame number absolutely within the slide */
            top: 60px; /* Adjust the vertical position as needed */
            left: 10px; /* Adjust the horizontal position as needed */
            background-color: rgba(255, 255, 255, 0.8); /* Semi-transparent white background */
            padding: 5px; /* Add some padding around the text */
            font-weight: bold; /* Make the text bold for better visibility */
            z-index: 1; /* Add this line to ensure the frame number is on top of the image */
        }

        .small-input-box {
            width: 40px; /* Adjust the width as needed */
        }

        .path-input-box {
            width: 500px; /* Adjust the width as needed */
        }

        .name-input-box {
            width: 250px; /* Adjust the width as needed */
        }

        .upload-button {
            margin-top: 10px;  /* Adjust padding as needed */
        }
    </style>
</head>
<body>
    <h1>Explore Pose Embeddings</h1>

    <form method='POST' enctype='multipart/form-data' id="uploadForm">
        {{ uploadform.hidden_tag() }}
        {{ uploadform.csrf_token }}
       
        <div> 
            {{ uploadform.folder.label }} 
            <input type="text" id="folderInput" name="folder" class="path-input-box" onchange="updateFolderList()">
        </div>

        <div> 
            {{ plotlyform.load_plot.label }} 
            <input type="checkbox" id="loadPlotCheckbox" name="load_plot" onchange="toggleFieldsVisibility()">
        </div>

        <div id="additionalOptions2" style="display:none;">
            <div class="flex-row">
                {{ loadnameform.loadname.label }}
                <select id="folderList" class="name-input-box" name="loadname"></select>
            </div>
        </div>

        <div id="additionalOptions" style="display:none;">
            <div> 
                {{ nameform.name.label }} {{ nameform.name(class = 'name-input-box')}}
            </div>

            <div>
                {{ parameterform.fps.label }} {{ parameterform.fps(class = 'small-input-box') }} 
            </div>
            
            <div>
                {{ fractionform.slider.label }} {{ fractionform.slider() }}
                <span id="fractionValue" style="margin-left: 10px;">0.1</span>
            </div>
            
            <div>
                {{ parameterform.umap_min_dist.label }} {{ parameterform.umap_min_dist(class = 'small-input-box') }} 
            </div>
        
            <div>
                {{ parameterform.umap_random_state.label }} {{ parameterform.umap_random_state(class = 'small-input-box') }} 
            </div>
        
            <div>
                {{ parameterform.hdbscan_min_samples.label }} {{ parameterform.hdbscan_min_samples(class = 'small-input-box') }} 
            </div>
        
            <div>
                {{ parameterform.hdbscan_cluster_min.label }} {{ parameterform.hdbscan_cluster_min(class = 'small-input-box') }} 
            </div>
        
            <div>
                {{ parameterform.hdbscan_cluster_max.label }} {{ parameterform.hdbscan_cluster_max(class = 'small-input-box') }} 
            </div>
        </div>

        <div>
            {{ keypointform.keypoints.label }} {{ keypointform.keypoints() }} 
        </div>

        <div>
            {{ uploadform.upload(class = 'upload-button')}}
        </div>

        <div id="radioControl" style="display:none;">
            <input type="radio" id="single" name="return" value="single" checked>
            <label for="single">Load single frame</label>
            <input type="radio" id="sequential_mp4" name="return" value="sequential_mp4">
            <label for="sequential_mp4">Swipe through sequential mp4 frames</label>
            <input type="radio" id="sequential_cluster" name="return" value="sequential_cluster">
            <label for="sequential_cluster">Swipe through sequential cluster frames</label>
        </div>

    </form>

    <form method='POST' enctype='multipart/form-data'>
        {{ clusterform.hidden_tag() }}
        {{ clusterform.csrf_token }}
        <div>
            {{ clusterform.cluster(class = 'upload-button') }} 
        </div>
    </form>

    <div class="container">
        <div id="graph"></div>
        <div class="swiper-container" id="frame-container">
            <div class="swiper-wrapper">
    
            </div>
            <div class="swiper-button-prev"></div>
            <div class="swiper-button-next"></div>
        </div>
    </div>
    
    <div id="plot-info"></div>

    <script type="text/javascript">

        document.addEventListener('DOMContentLoaded', function() {
            const uploadForm = document.getElementById('uploadForm');
            const loadPlotCheckbox = document.getElementById('loadPlotCheckbox');

        var checkbox = document.getElementById('loadPlotCheckbox');
        toggleFieldsVisibility();  // Set initial visibility based on checkbox state
        checkbox.addEventListener('change', toggleFieldsVisibility);
    });

    function toggleFieldsVisibility() {
        var checkbox = document.getElementById('loadPlotCheckbox');

        if (checkbox.checked) {
            document.getElementById('additionalOptions').style.display = 'none'; // Hide additionalOptions
            document.getElementById('additionalOptions2').style.display = 'block';
        } else {
            document.getElementById('additionalOptions').style.display = 'block'; // Show additionalOptions
            document.getElementById('additionalOptions2').style.display = 'none';
        }
    }   
    
    document.getElementById('folderInput').addEventListener('change', updateFolderList);

        function updateFolderList() {
            var path = document.getElementById('folderInput').value;
            fetch('/get_folders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({path: path})
            })
            .then(response => response.json())
            .then(data => {
                var select = document.getElementById('folderList');
                select.innerHTML = ''; // Clear existing options
                data.forEach(function(folder) {
                    var option = new Option(folder, folder);
                    select.options.add(option);
                });
            })
            .catch(error => console.error('Error fetching folders:', error));
        }

        const fraction = document.querySelector('#{{ fractionform.slider.id }}');
        const display = document.getElementById('fractionValue');
        display.textContent = fraction.value

        fraction.oninput = function() {
        display.textContent = this.value;
        }

        const minField = document.getElementById('{{ parameterform.hdbscan_cluster_min.id }}');
        const maxField = document.getElementById('{{ parameterform.hdbscan_cluster_max.id }}');

        // Function to update constraints
        function updateConstraints() {
            const minValue = parseFloat(minField.value); // Get the current value of hdbscan_cluster_min
            const maxValue = parseFloat(maxField.value); // Get the current value of hdbscan_eps_max

            // Set the min attribute of hdbscan_cluster_max to ensure it's not less than hdbscan_cluster_min
            maxField.min = minValue;

            // If the current max is less than the new min, adjust it to match the min
            if (maxValue < minValue) {
                maxField.value = minValue;
            }
        }

        // Attach event listeners to both fields
        [minField, maxField].forEach(field => field.addEventListener('input', updateConstraints));

        // Initial constraint update on page load
        updateConstraints();
            
        var graph = {{graphJSON | safe}};
            console.log(graph); 
            if (graph) {
                Plotly.newPlot('graph', graph, {});
                // Show the radio button when the plot is available
                document.getElementById('radioControl').style.display = 'block';
            }
            var plotDiv = document.getElementById('graph');
        plotDiv.on('plotly_click', function(data) {
            var clickInfo = data.points.map(function(point) {
                return {
                    'x': point.x,
                    'y': point.y,
                    'z': point.z,
                    'frame_mapping': point.customdata[0],
                    'frame_number': point.customdata[1],
                    'assignment': point.customdata[2]
                };
            });

            var selectedRadioValue = document.querySelector('input[name="return"]:checked').value;

            var infoDiv = document.getElementById('plot-info');
            infoDiv.innerHTML = '';

            clickInfo.forEach(function(info) {
                var infoElement = document.createElement('p');
                infoElement.textContent = 'x: ' + info.x.toFixed(3) + ', y: ' + info.y.toFixed(3) + ', z: ' + info.z.toFixed(3) +
                                      ', mapped frame: ' + info.frame_mapping + ', mp4 frame: ' + info.frame_number + ', assignment: ' + info.assignment;
                infoDiv.appendChild(infoElement);
            }); 

            $.ajax({
                url: '/process_click_data',
                type: 'POST',
                data: JSON.stringify({
                    clickData: clickInfo,
                    radioButtonValue: selectedRadioValue  
                }),
                contentType: 'application/json',
                success: function(response) {
                    console.log('Click data sent successfully:', response);

                    var swiperWrapper = document.querySelector('.swiper-wrapper');
                    swiperWrapper.innerHTML = ''; // Clear existing slides

                    if (response.frame_data && response.frame_data.length > 0) {
                        response.frame_data.forEach(function(frameData, index) {
                            var slide = document.createElement('div');
                            slide.className = 'swiper-slide';

                            var zoomContainer = document.createElement('div');
                            zoomContainer.className = 'swiper-zoom-container';

                            var frameNumber = document.createElement('div');
                            frameNumber.className = 'frame-number';
                            frameNumber.textContent = 'Frame: ' + response.frames[index];

                            var assignment = document.createElement('div');
                            assignment.className = 'frame-assignment';
                            assignment.textContent = 'Assignment: ' + response.assignments[index];

                            var frameImage = document.createElement('img');
                            frameImage.src = 'data:image/jpeg;base64,' + frameData;
                            frameImage.style.width = '100%'; // Full width of the slide
                            frameImage.style.height = 'auto'; // Maintain aspect ratio

                            zoomContainer.appendChild(frameImage);
                            slide.appendChild(frameNumber);
                            slide.appendChild(assignment);
                            slide.appendChild(zoomContainer);
                            swiperWrapper.appendChild(slide); // Append the slide to the swiper wrapper
                        });

                        var middleIndex = Math.floor(response.frame_data.length / 2);

                        // Initialize or update Swiper

                        if (window.mySwiper) {
                            window.mySwiper.destroy(true, true);
                        }
                        window.mySwiper = new Swiper('.swiper-container', {
                            loop: false,
                            navigation: {
                                nextEl: '.swiper-button-next',
                                prevEl: '.swiper-button-prev',
                            },
                            zoom: {
                                enabled: true,
                                maxRatio: 5,  // Maximum zoom ratio
                                minRatio: 1,  // Minimum zoom ratio (default scale)
                            },
                            initialSlide: middleIndex
                            });
                       
                        window.mySwiper.update(); // Update Swiper if already initialized
                        frameNumberContainer.textContent = 'Frame Number: ' + response.frames[window.mySwiper.activeIndex];
                    
                    } else {
                        console.error("No images returned from the server.");
                    }
                },
                error: function(error) {
                    console.error('Error sending click data:', error);
                }
            });
        }) 

      

    </script>
</body>
</html>